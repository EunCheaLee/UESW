<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="/js/env.js"></script>
	<title>weather</title>
</head>

<body>

	<section th:fragment="mainWeather" style="width: 650px;">

		<!-- ì¦ê²¨ì°¾ê¸° ëª©ë¡ -->
		<div id="favorites-container" style="margin-top: 10px;">
			<h4>ì¦ê²¨ì°¾ê¸° ëª©ë¡
				<ul id="favorites-list" style="list-style: none; padding-left: 0;"></ul>
			</h4>
		</div>

		<!-- ë“œë¡­ë°•ìŠ¤ -->
		<div class="dropdown-container">
			<!-- ì²«ë²ˆì§¸ ë“œë¡­ë‹¤ìš´ : ì§€ì—­ ì„ íƒ -->
			<select id="region">
				<option value="">ì§€ì—­ ì„ íƒ</option>
				<option value="east">ë™ë¶€</option>
				<option value="west">ì„œë¶€</option>
				<option value="south">ë‚¨ë¶€</option>
				<option value="north">ë¶ë¶€</option>
			</select>

			<!-- ë‘ë²ˆì§¸ ë“œë¡­ë‹¤ìš´ : êµ¬ ì„ íƒ -->
			<select id="district">
				<option value="">êµ¬ ì„ íƒ</option>
			</select>

			<div id="selected-region">
				ì„ íƒí•œ ì§€ì—­: <span class="region-display">ì¢…ë¡œêµ¬</span>
				<button id="add-favorite-btn">ì¦ê²¨ì°¾ê¸° ì¶”ê°€</button>
			</div>

		</div>

		<!-- ì²« ë²ˆì§¸ : ê¸°ìƒì •ë³´ -->
		<div class="weather-box" id="weather-box"></div>


		<!-- ë‘ ë²ˆì§¸ : ê¸°ìƒì°¨íŠ¸  -->
		<div class="temperature-chart-container">
			<h3>ì‹œê°„ë³„ ê¸°ì˜¨</h3>
			<canvas id="temperatureChart"></canvas>
		</div>

		<script>
			const API_KEY = CONFIG.WEATHER_API_KEY;
			const API_URL = 'https://api.openweathermap.org/data/2.5/forecast';

			let regionCoords = {
				east: {districts: {}},
				west: {districts: {}},
				south: {districts: {}},
				north: {districts: {}}
			};

			// ë°ì´í„°ë¥¼ ë‹¤ ë¶ˆëŸ¬ì˜¤ê³  ë‚œ ë‹¤ìŒ ì‹¤í–‰í•˜ëŠ” ì´ˆê¸°í™” í•¨ìˆ˜
			function initializePage() {
				regionSelect.value = 'north';
				updateDistricts();
				districtSelect.value = 'ì¢…ë¡œêµ¬';
				regionDisplay.textContent = 'ì¢…ë¡œêµ¬';
				fetchWeatherData('north', 'ì¢…ë¡œêµ¬');
			}

			fetch('/api/seoul/all')
				.then(response => response.json())
				.then(data => {
					data.forEach(item => {
						const region = item.region;  // east, west, south, north
						const gu = item.gu;          // êµ¬ ì´ë¦„
						const lat = item.lat;
						const lon = item.lon;

						// JS ê°ì²´ì— ì¶”ê°€
						if (regionCoords[region]) {
							regionCoords[region].districts[gu] = {lat: lat, lon: lon};
						}
					});

					// ğŸ“Œ regionCoords ë‹¤ ë¡œë“œëœ ì´í›„ì— ì´ˆê¸°í™” ì‹œì‘
					initializePage();
				})
				.catch(error => {
					console.error('Error:', error);
				});

			const value = JSON.parse(localStorage.getItem('key'));
			const regionSelect = document.getElementById('region');
			const districtSelect = document.getElementById('district');
			const weatherBox = document.getElementById('weather-box');
			const addFavoriteBtn = document.getElementById('add-favorite-btn');
			const favoritesList = document.getElementById('favorites-list');
			const regionDisplay = document.querySelector('.region-display');

			// ğŸ¯ 1. ì €ì¥ëœ ì¦ê²¨ì°¾ê¸° ë¶ˆëŸ¬ì˜¤ê¸°
			let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
			updateFavoritesUI();

			// ğŸ¯ 2. ì¦ê²¨ì°¾ê¸° UI ì—…ë°ì´íŠ¸
			function updateFavoritesUI() {
				favoritesList.innerHTML = '';
				favorites.forEach(fav => {
					const btn = document.createElement('button');
					btn.textContent = fav;

					// âœ… ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ
					btn.addEventListener('click', () => {
						console.log('ì‚­ì œ ë²„íŠ¼ í´ë¦­ë¨:', fav);
						removeFavorite(fav);
					});

					favoritesList.appendChild(btn);
				});
			}

			// ğŸ¯ 3. ì¦ê²¨ì°¾ê¸° ì¶”ê°€ í•¨ìˆ˜
			function addFavorite(region) {
				if (!region) {
					alert("ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”.");
					return;
				}

				if (favorites.includes(region)) {
					alert("ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ëœ ì§€ì—­ì…ë‹ˆë‹¤.");
					return;
				}

				if (favorites.length >= 3) {
					alert("ì¦ê²¨ì°¾ê¸°ëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
					return;
				}

				favorites.push(region);
				localStorage.setItem('favorites', JSON.stringify(favorites));
				updateFavoritesUI();
			}

			// ğŸ¯ 4. ì¦ê²¨ì°¾ê¸° ì‚­ì œ í•¨ìˆ˜
			function removeFavorite(region) {
				favorites = favorites.filter(f => f !== region);
				localStorage.setItem('favorites', JSON.stringify(favorites));
				updateFavoritesUI();
			}

			// ğŸ¯ 5. ì¶”ê°€ ë²„íŠ¼ í´ë¦­ ì‹œ ë™ì‘
			addFavoriteBtn.addEventListener('click', () => {
				const selectedRegion = regionDisplay.textContent.trim();

				if (!selectedRegion) {
					alert('ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
					return;
				}

				if (favorites.includes(selectedRegion)) {
					alert('ì´ë¯¸ ì¦ê²¨ì°¾ê¸°ì— ì¶”ê°€ëœ ì§€ì—­ì…ë‹ˆë‹¤.');
					return;
				}

				if (favorites.length >= 3) {
					alert('ì¦ê²¨ì°¾ê¸°ëŠ” ìµœëŒ€ 3ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
					return;
				}

				favorites.push(selectedRegion);
				localStorage.setItem('favorites', JSON.stringify(favorites)); // localStorageì €ì¥
				updateFavoritesUI();
			});

			// ì§€ì—­ ì„ íƒ ì‹œ ì„ íƒ ì§€ì—­ í…ìŠ¤íŠ¸ë„ ë³€ê²½ë˜ë„ë¡ ìˆ˜ì • (ê¸°ì¡´ ì½”ë“œì— ì¶”ê°€)
			districtSelect.addEventListener('change', () => {
				if (regionSelect.value && districtSelect.value) {
					fetchWeatherData(regionSelect.value, districtSelect.value);
					// ì„ íƒëœ êµ¬ë¥¼ í‘œì‹œ
					regionDisplay.textContent = districtSelect.value;
				}
			});

			// ì°¨íŠ¸ ì „ì—­ë³€ìˆ˜
			let temperatureChart = null;
			// APIì—ì„œ ë°›ì€ ì „ì²´ 3ì‹œê°„ ë°ì´í„° ì €ì¥
			let currentWeatherList = [];

			function updateDistricts() {
				const selectedRegion = regionSelect.value;
				districtSelect.innerHTML = '<option value="">êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';

				if (selectedRegion) {
					const districts = regionCoords[selectedRegion].districts;
					for (const district in districts) {
						const option = document.createElement('option');
						option.value = district;
						option.text = district;
						districtSelect.appendChild(option);
					}
				}
			}

			async function fetchWeatherData(region, district) {
				const {lat, lon} = regionCoords[region].districts[district];

				try {
					const response = await fetch(`${API_URL}?lat=${lat}&lon=${lon}&units=metric&cnt=40&appid=${API_KEY}`);
					const data = await response.json();

					if (!data.list || data.list.length === 0) {
						weatherBox.innerHTML = '<p>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
						return;
					}

					currentWeatherList = data.list;
					displayWeatherSummary(data.list);
					
					// âœ… ì—¬ê¸°ì— ì¶”ê°€!
					checkRainCondition(data.list);
					
					// ê¸°ë³¸ìœ¼ë¡œ ì²« ë‚ ì§œ ê·¸ë˜í”„ í‘œì‹œ (ì²« ë°ì´í„° ë‚ ì§œ)
					if (data.list.length > 0) {
						const firstDate = new Date(data.list[0].dt * 1000).toISOString().slice(0, 10);
						renderTemperatureChartForDate(firstDate);
					}
				} catch (error) {
					console.error("ë‚ ì”¨ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
					weatherBox.innerHTML = '<p>ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
				}
			}

			function displayWeatherSummary(list) {
				// ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘: ë‚ ì§œ(yyyy-mm-dd)ë³„ ì²« ì•„ì´í…œ ëŒ€í‘œë¡œ ìš”ì•½ ì¹´ë“œ ìƒì„±
				const dailyMap = {};
				list.forEach(item => {
					const dateObj = new Date(item.dt * 1000);
					dateObj.setHours(dateObj.getHours());  // í•œêµ­ ì‹œê°„ ë³´ì •
					const dateStr = dateObj.toISOString().slice(0, 10);
					if (!dailyMap[dateStr]) {
						dailyMap[dateStr] = item;
					}
				});

				weatherBox.innerHTML = '';
				for (const dateStr in dailyMap) {
					const item = dailyMap[dateStr];

					// âœ… dateObj ìƒˆë¡œ ì„ ì–¸í•´ì•¼ í•¨
					const itemDateObj = new Date(item.dt * 1000);
					itemDateObj.setHours(itemDateObj.getHours());
					const day = itemDateObj.getDate();

					// âœ… í•´ë‹¹ ë‚ ì§œ ì „ì²´ ë°ì´í„° ì¶”ì¶œ (ë³´ì • í¬í•¨)
					const itemsOfDay = list.filter(i => {
						const dateObj = new Date(i.dt * 1000);
						dateObj.setHours(dateObj.getHours());
						const itemDateStr = dateObj.toISOString().slice(0, 10);
						return itemDateStr === dateStr;
					});

					// âœ… ì•„ì´ì½˜ ë¹ˆë„ìˆ˜ ê³„ì‚°
					const iconCount = {};
					itemsOfDay.forEach(i => {
						const iconCode = i.weather[0].icon;
						iconCount[iconCode] = (iconCount[iconCode] || 0) + 1;
					});

					// âœ… ê°€ì¥ ë§ì´ ë‚˜ì˜¨ ì•„ì´ì½˜ ì„ íƒ
					const mostFrequentIcon = Object.keys(iconCount).reduce((a, b) => iconCount[a] > iconCount[b] ? a : b);
					const iconUrl = `https://openweathermap.org/img/wn/${mostFrequentIcon}@2x.png`;
					// âœ… ìµœê³ /ìµœì € ì˜¨ë„ ê³„ì‚° (ë³´ì • í¬í•¨)
					const tempsOfDay = itemsOfDay.map(i => i.main.temp);
					const tempMax = Math.max(...tempsOfDay).toFixed(1);
					const tempMin = Math.min(...tempsOfDay).toFixed(1);


					const div = document.createElement('div');
					div.className = 'weather-item';
					div.dataset.date = dateStr;
					div.className = 'weather-item';  // divì— í´ë˜ìŠ¤ëª… ì¶”ê°€
					div.innerHTML = `
			    <h4 class="weather-day">${day}ì¼</h4>
			    <img src="${iconUrl}" alt="weather icon" class="weather-icon" />
			    <div class="weather-bottom">
			        <div class="temp-max">${tempMax}</div>
			        <div class="temp-min">${tempMin}</div>
			    </div>
			`;

					// í´ë¦­ ì´ë²¤íŠ¸ë¡œ í•´ë‹¹ ë‚ ì§œì˜ ì‹œê°„ë³„ ì˜¨ë„ ê·¸ë˜í”„ í‘œì‹œ
					div.addEventListener('click', () => {
						renderTemperatureChartForDate(dateStr);
					});

					weatherBox.appendChild(div);
				}
			}

			function renderTemperatureChartForDate(dateStr) {
				// dateStr ê¸°ì¤€ìœ¼ë¡œ currentWeatherListì—ì„œ ì‹œê°„ë³„ ì˜¨ë„ ì¶”ì¶œ
				const filtered = currentWeatherList.filter(item => {
					const dateObj = new Date(item.dt * 1000);
					dateObj.setHours(dateObj.getHours());
					const itemDateStr = dateObj.toISOString().slice(0, 10);
					return itemDateStr === dateStr;
				});
				if (filtered.length === 0) {
					alert('í•´ë‹¹ ë‚ ì§œì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
					return;
				}

				const labels = filtered.map(item => {
					const d = new Date(item.dt * 1000);
					return d.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
				});

				// ê°•ìˆ˜ëŸ‰ 
				const rains = filtered.map(item => (item.rain && item.rain['3h']) ? item.rain['3h'] : 0);
				// ìµœì €, ìµœê³  ê¸°ì˜¨
				const temps = filtered.map(item => item.main.temp);

				if (temperatureChart) {
					temperatureChart.destroy();
				}

				const ctx = document.getElementById('temperatureChart').getContext('2d');
				const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);

				gradient.addColorStop(0, '#ffc7b1c2');      // ë¶„í™ ì‹œì‘ (0%)
				gradient.addColorStop(0.25, '#ff956f91');     // ë¶„í™->ë…¸ë‘ ì¤‘ê°„ìƒ‰ (ì‚´ì§ ë…¸ë€ ëŠë‚Œ)
				gradient.addColorStop(0.95, '#fff51675');        // ë…¸ë‘ ë (100%)



				temperatureChart = new Chart(ctx, {
					type: 'line',
					data: {
						labels,
						datasets: [
							{
								type: 'line',
								label: `ì‹œê°„ë³„ ê¸°ì˜¨ (Â°C)`,
								data: temps,
								borderColor: '#ffc7b1c2',
								backgroundColor: gradient,
								fill: true,
								tension: 0.4,
								yAxisID: 'y2',
								order: 2
							},
							{
								type: 'line',
								label: 'ì‹œê°„ë³„ ê°•ìˆ˜ëŸ‰ (mm)',
								data: rains,
								borderColor: '#5ab9ffe0',
								backgroundColor: '#8cceff99',
								fill: true,
								tension: 0.4,
								yAxisID: 'y1',
								order: 1
							}
						]
					},
					options: {
						responsive: true,
						scales: {
							y2: {
								type: 'linear',
								position: 'left',
								min: 0,           // ğŸ‘ˆ ìµœì € ê¸°ì˜¨ ê³ ì •
								max: 40,            // ğŸ‘ˆ ìµœê³  ê¸°ì˜¨ ê³ ì •
								title: {
									display: true,
									text: 'ê¸°ì˜¨ (Â°C)'
								}
							},
							y1: {
								type: 'linear',
								position: 'right',
								min: 0,
								max: Math.max(...rains) + 1,
								grid: {
									drawOnChartArea: false, // y2ì¶• ëˆˆê¸ˆì€ ë°°ê²½ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ
								},
								title: {
									display: true,
									text: 'ê°•ìˆ˜ëŸ‰ (mm)'
								}
							},
							x: {
								title: {
									display: true,
									text: 'ì‹œê°„'
								}
							}
						}
					}
				});
			}

			regionSelect.addEventListener('change', () => {
				updateDistricts();
				districtSelect.value = '';  // êµ¬ ì´ˆê¸°í™”
				regionDisplay.textContent = '';  // ì„ íƒí•œ ì§€ì—­ í‘œì‹œë„ ì´ˆê¸°í™” (ìˆìœ¼ë©´)
			});

			districtSelect.addEventListener('change', () => {
				if (regionSelect.value && districtSelect.value) {
					fetchWeatherData(regionSelect.value, districtSelect.value);
					regionDisplay.textContent = districtSelect.value;
				}
			});
		</script>


</body>

</html>