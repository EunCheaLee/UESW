<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${board.title}">ê²Œì‹œê¸€ ë³´ê¸°</title>
	<link rel="stylesheet" th:href="@{/css/board.css}"/>
	<link rel="stylesheet" th:href="@{/css/fragments.css}">
	<script th:src="@{/js/session.js}"></script>
	<script th:src="@{/js/board.js}" defer></script>
	<script th:src="@{/js/fragments.js}" defer></script>
	<!-- Toast UI Viewer -->
	<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
	<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
	<style>
		.view-container{
			margin-top:100px;
		}
	</style>

</head>
<body>

	<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
	<div th:replace="~{fragments/nav :: mainNav}"></div>
	<!-- ê³ ì • ì‚¬ì´ë“œë°” -->
	<div th:replace="~{fragments/sidebar :: mainSidebar}"></div>
	
	  <div class="view-container">
	      <div class="view-content">
	          <table class="select-table">
	              <tr style="border-bottom: 1px solid gray;">
	                  <td style="width: 300px;">
	                      <h2 style="text-align: left;">ê²Œì‹œê¸€</h2>
	                  </td>
	                  <td class="view-num">
	                      <p>ì¡°íšŒìˆ˜: <span th:text="${board.viewNum}"></span></p>
	                  </td>
	              </tr>
	              <tr>
	                  <td colspan="2" class="select-title">
	                      <strong>ì œëª©</strong> <span style="margin-left: 15px;" th:text="${board.title}"></span>
	                  </td>
	              </tr>
	              <tr style="border-bottom: 1px solid gray;">
	                  <td style="padding-bottom: 20px; width: 350px;">
						<strong>ì‘ì„±ì</strong>
						<span style="margin-left: 15px;"
						      th:text="${board.user != null ? board.user.userName : 'ë¹„íšŒì›'}"></span>
	                  </td>
	                  <td style="padding-bottom: 20px; width: 350px;">
	                      <strong>ì‘ì„±ì¼</strong> <span style="margin-left: 15px;" th:text="${#temporals.format(board.writeDate, 'yyyy-MM-dd HH:mm')}"></span>
	                  </td>
	              </tr>
	          </table>

			  <!-- Toast UI Editor Viewer (ì½ê¸° ì „ìš© ëª¨ë“œ) -->
			  <div id="viewer-container">
			      <div id="viewer" th:attr="data-content=${board.content}"></div>
			  </div>
			  
	          <table class="select-table">
	              <tr class="select-file-group">
	                  <th class="select-file"><strong>ì²¨ë¶€ íŒŒì¼ |</strong></th>
	                  <td class="select-file-content">
	                      <span th:if="${board.filename == null}">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</span>
	                      <a th:if="${board.filename != null}" th:href="@{'/board/upload/' + ${board.filename}}"
	                         th:text="${board.filename}">íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
	                  </td>
	              </tr>
	              <tr>
	                  <td colspan="2">
	                      <div class="view-button-container">
	                          <form action="/board/list" method="get" style="display:inline;">
	                              <button class="view-button" type="submit">ëª©ë¡</button>
	                          </form>
	                          <form th:action="@{/board/update/{id}(id=${board.id})}" method="get" style="display:inline;">
	                              <button class="view-button" type="submit">ìˆ˜ì •</button>
	                          </form>
	                          <form th:action="@{/board/delete}" method="post" style="display:inline;">
	                              <input type="hidden" th:name="id" th:value="${board.id}" />
	                              <button class="view-button" type="submit" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
	                          </form>
	                      </div>
	                  </td>
	              </tr>
	          </table>
	      </div>
	  </div>

	  <!-- ë¡œê·¸ì¸ëœ ê²½ìš° -->
	  <div class="reply-container" th:if="${userId != null}">
			<form method="post" th:action="@{'/board/' + ${board.id} + '/comment'}">
				<label style="text-align: start;" for="reply-insert">âœï¸ ëŒ“ê¸€ ì‘ì„±</label>
				<textarea name="content" id="reply-insert" required></textarea>
			    <!-- âŒ userIdëŠ” ì„œë²„ì—ì„œ ì„¸ì…˜ìœ¼ë¡œ ê°€ì ¸ì˜¤ë¯€ë¡œ ì œê±° -->
			    <br/>
				<div class="reply-button-wrapper">
					<button type="submit" id="reply-button">ëŒ“ê¸€ ë“±ë¡</button>
				</div>
			</form>
		
			<!-- ëŒ“ê¸€ ëª©ë¡ -->
			<h4>ëŒ“ê¸€ ëª©ë¡</h4>
			<div th:each="reply : ${comments}" class="reply-item" th:data-id="${reply.id}" th:style="'margin-left:' + ${reply.depth * 30} + 'px;'">
			    <div class="reply-info">
			        <div class="reply-top">
						
						<span class="reply-indent">
							<i th:if="${reply.depth > 0}" class="bi bi-arrow-return-right"></i>
						</span>
				            <strong id="reply-writer" th:text="${reply.user != null ? reply.user.userName : 'ë¹„íšŒì›'}">ì‘ì„±ì</strong>
							<!-- âœ… ëŒ“ê¸€ ë‚´ìš© ì¶œë ¥ ì˜ì—­ -->
						    <span class="reply-content" th:text="${reply?.content ?: 'ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤.'}">ëŒ“ê¸€ ë‚´ìš©</span>
			            
						   <!-- ëŒ“ê¸€ ìˆ˜ì • í¼ (ê¸°ë³¸ì€ ìˆ¨ê¹€) -->
	   						<form class="edit-form" style="display: none;">
	   						    <textarea class="edit-textarea" rows="2" required
	   						              th:text="${reply.content}">ëŒ“ê¸€ ë‚´ìš©</textarea>
	   						    <button type="button" class="save-button link-button">ì €ì¥</button>
	   						    <button type="button" class="cancel-button link-button">ì·¨ì†Œ</button>
	   						</form>
						   
						   <div class="reply-likes">
			                <button type="button" class="like-button">â¤ï¸ <span class="like-count" th:text="${reply.likes}">0</span></button>
			            </div>
			        </div>
			    </div>
			    <div class="reply-edit-info">
			        <button type="button" class="link-button toggle-reply-form">ë‹µê¸€</button>
			        <form method="post" th:action="@{'/reply/' + ${reply.id} + '/reply'}" class="reply-form hidden">
			            <textarea name="content" rows="2" placeholder="ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
			            <button type="submit" class="link-button">ë“±ë¡</button>
			        </form>
			        <form th:action="@{'/reply/' + ${reply.id} + '/report'}" method="post" style="display: inline;">
			            <button type="submit" onclick="return confirm('ì‹ ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="link-button">ì‹ ê³ </button>
			        </form>
			        <span th:if="${userId == reply.user?.id}">
			            <button type="button" class="edit-button link-button">ìˆ˜ì •</button>
			            <form th:action="@{'/reply/' + ${reply.id} + '/delete'}" method="get" style="display: inline;">
			                <button type="submit" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" class="link-button">ì‚­ì œ</button>
			            </form>
						
			        </span>
			    </div>
			</div>

			<!-- â— ëŒ“ê¸€ì´ í•˜ë‚˜ë„ ì—†ì„ ê²½ìš° -->
			<div th:if="${#lists.isEmpty(comments)}">
			    <p>ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
			</div>
	  </div>

	  <!-- ë¹„ë¡œê·¸ì¸ ìƒíƒœ -->
	  <div th:if="${userId == null}">
	      <p>ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
	  </div>
	  
	  <!-- í‘¸í„° -->
	  <div th:replace="~{fragments/footer :: footer}"></div>
	  <!-- ìœ„ë¡œê°€ê¸° -->
	  <div th:replace="~{fragments/top-btn :: top-btn}"></div>  
	
	  <script>
	      const content = document.querySelector('#viewer').dataset.content;
	      const viewer = new toastui.Editor.factory({
	          el: document.querySelector('#viewer'),
	          viewer: true,  // ë³´ê¸° ì „ìš© ëª¨ë“œ ì„¤ì •
	          initialValue: content
	      });

	      // ì¶”ê°€ì ìœ¼ë¡œ ìŠ¤íƒ€ì¼ì„ ì¡°ì •í•˜ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
	      document.querySelector('#viewer').style.width = '100%'; // ë„ˆë¹„ 100%ë¡œ ì„¤ì •
	  
		  // ëŒ“ê¸€ ì¢‹ì•„ìš” ê¸°ëŠ¥
		  document.addEventListener("click", (e) => {
		      if (e.target.matches(".like-button")) {
		          const btn = e.target;
		          const replyItem = btn.closest(".reply-item");
		          const replyId = replyItem.dataset.id;
		          fetch(`/reply/${replyId}/like`, { method: "POST" })
		              .then(res => res.json())
		              .then(data => {
		                  if (data.success) {
		                      replyItem.querySelector(".like-count").innerText = data.likes;
		                  } else {
		                      alert("í•œ ë²ˆë§Œ ëˆ„ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
		                  }
		              });
		      }
			  // âœï¸ ìˆ˜ì •
		      if (e.target.matches(".edit-button")) {
		          const replyItem = e.target.closest(".reply-item");
		          replyItem.querySelector(".edit-form").style.display = "block";
		          replyItem.querySelector(".reply-content").style.display = "none";
		      }
			  // âŒ ì·¨ì†Œ
		      if (e.target.matches(".cancel-button")) {
		          const replyItem = e.target.closest(".reply-item");
		          replyItem.querySelector(".edit-form").style.display = "none";
		          replyItem.querySelector(".reply-content").style.display = "inline";
		      }
			  // ğŸ’¾ ì €ì¥
		      if (e.target.matches(".save-button")) {
		          const replyItem = e.target.closest(".reply-item");
		          const replyId = replyItem.dataset.id;
		          const newContent = replyItem.querySelector(".edit-textarea").value;

		          fetch(`/reply/${replyId}/edit`, {
		              method: "POST",
		              headers: { "Content-Type": "application/x-www-form-urlencoded" },
		              body: new URLSearchParams({ content: newContent })
		          })
		          .then(res => {
		              if (res.ok) return res.text();
		              else throw new Error("ìˆ˜ì • ì‹¤íŒ¨");
		          })
		          .then(() => {
		              replyItem.querySelector(".reply-content").innerText = newContent;
		              replyItem.querySelector(".reply-content").style.display = "inline";
		              replyItem.querySelector(".edit-form").style.display = "none";
		          })
		          .catch(err => {
		              alert("ëŒ“ê¸€ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
		              console.error(err);
		          });
		      }
			  
			  // ë‹µê¸€ í† ê¸€
	          if (e.target.matches(".toggle-reply-form")) {
	              const replyItem = e.target.closest(".reply-item");
	              const replyForm = replyItem.querySelector(".reply-form");
	              if (replyForm) replyForm.classList.toggle("hidden");
			  }
		  });
	  </script>
</body>
</html>
